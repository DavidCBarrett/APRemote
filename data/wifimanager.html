<!-- 
DCB's WiFi Manager page
Some inspiration from https://github.com/khoih-prog/ESP_WiFiManager_Lite/blob/main/src/ESP_WiFiManager_Lite.hpage   
-->  
<!DOCTYPE html>
<html>
    <head>
        <title>Wi-Fi Manager</title>
        <meta name='viewport' content='width=device-width, initial-scale=1'>
        <style>
            div,input{padding:5px;font-size:100%;}
            select{text-align:left;display:inline-block;min-width:260px;font-size:100%;padding:5px;}
            input{width:95%;}
            body{text-align:center;}
            button{background-color:#16A1E7;color:#fff;line-height:2rem;font-size:100%;width:90%;}
            fieldset{border-radius:0.6rem;margin:0px;}
        </style>
    </head>
<body>
    <div style="font-size:80%;">
        <h1>Configure WiFi</h1>
    </div>
    <div style='text-align:left;display:inline-block;min-width:260px;'>
        <fieldset>
            <label for="PrimarySSID"><strong>Primary Network :</strong></label><br>
            <div>
                <select id='PrimarySSID'>
                    <option>Select primary network ...</option>
                </select>
            </div>
            <label for="PrimaryPwd">Password</label> 
            <div><input value='' id='PrimaryPwd'></div>
            <hr>
            <label for="SecondarySSID"><strong>Secondary Network :</strong></label><br>
            <div>
                <select id='SecondarySSID'>
                    <option>Select secondary network ...</option>
                </select>
            </div>
            <label for="SecondarydPwd">Password</label> 
            <div><input value='' id='SecondarydPwd'></div>
            <hr>
                <label>Status: </label><label id="status"></label>
        </fieldset>
        <div></div>
        <table style='min-width:300px;'>
            <tr>
                <td align="center"><button onclick="scanWiFiNetworks()">Scan</button></td>
                <td align="center"><button onclick="saveWiFiCrendentials()">Save</button></td>
                <td align="center"><button onclick="clearWiFiCrendentials()">Clear</button></td>
                <td align="center"><button onclick="cancel()">Cancel</button></td>
            </tr>
        </table>
    </div>

    <script src="reconnecting-websockets.js"></script>
    <script id=\"jsbin-javascript\">

        var url = `ws://${window.location.hostname}/ws`;
        var Socket;
        var scanWiFiResults;
        var retrievedWiFiCredentials; 

        window.onload = function(event) {
            // Create websocket object and set up handlers.
            document.addEventListener("DOMContentLoaded", function() {
                Socket = new ReconnectingWebSocket(url);
                Socket.debug = true;
                Socket.timeoutInterval = 1000;

                Socket.onopen = () => {
                    console.log("Websocket connection established")
                }

                Socket.onclose = () => {
                    console.log("Websocket connection closed")
                }

                Socket.onerror = error => {
                    console.log(error)
                }

                Socket.onmessage = function(event) {
                    processCommand(event);
                }
            })

            // initial WiFi scan
            scanWiFiNetworks();
            // retrieves current WiFi credentials.
            retrievedWiFiCredentials();
            // TODO - need to wait for the above calls to finish first??
            // if stored WiFi SSID is in the scan results, select it in the list
            for(SSID of scanWiFiResults.SSIDs) {
                for(elem of ["PrimarySSID", "SecondarySSID"]) {
                    if(SSID = elem.value)
                        // TODO: need to check if set attribute is the right method??
                        document.getElementById(elem).setAttributeNode(elem.value);
                        document.getElementById(elem).setAttributeNode(elem.value);
                }
            }
        }
        
        // handler for incomming websocket events
        function processCommand(event) {
            console.log("Websocket data received:");
            console.log(event.data);

            var data = JSON.parse(event.data);   // The parse turns the JSON document into a Javascript object

            if(data.Msg =="retrievedWiFiCredentials") {
                // The expected JSON document is in the same format as saveWiFiCrendentials fuction below
                retrievedWiFiCredentials = data.MsgBody;
            }
        }

        // Request a WiFI scan (HTTP GET), and handle scan results
        function scanWiFiNetworks() {
            document.getElementById("status").innerHTML = "Scanning...";
            console.log("Scanning WiFi Networks...");

            //clear any old entries in the list box (remove all but 1st entries)...
            var listbox, index;
            
            listbox= document.querySelector('#PrimarySSID');
            index = listbox.options.length;
            while (index-- > 1) listbox.remove(index);
            listbox= document.querySelector('#SecondarySSID');
            index = listbox.options.length;
            while (index-- > 1) listbox.remove(index);

            // Construct the 'scanWiFiNetwork" HTTP GET request
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'scanWiFiNetworks');

            // Define the handler for the response to the HTTP GET request:
            xhr.onload = function() {
                if (xhr.status === 200) {
                    if (xhr.responseText) { // if the returned data is not null, update the values
                        console.log("scanWiFiNetworks response:");
                        console.log(xhr.responseText);
                        
                        // The expected JSON document is in the format "{"SSIDs":["Net1","Net2", ...]}"
                        // The parse turns the JSON document into a Javascript object
                        scanWiFiResults = JSON.parse(xhr.responseText);

                         // Add WiFi networks to the HTML drop-down options. data.SSIDs is the array 
                         // of SSID's e.g a text string. 
                         // note using "for(e of array)" returns the text, and "for(e in array)" 
                         // returns just the index
                         for(SSID of scanWiFiResults.SSIDs) {
                            for(elem of ["PrimarySSID", "SecondarySSID"]) {
                                var option = document.createElement("option");
  			                    option.text = SSID;
   			                    document.getElementById(elem).add(option);
                            }
                       }
                    }
                }
                document.getElementById("status").innerHTML = "Scan complete";
            };

            // Send the 'scanWiFiNetwork" HTTP GET request to the client
            xhr.send();
        }

        function readWiFiCrendentials() {
            var data = {
                Msg: "readWiFiCredentials"
            };
            const myJSON = JSON.stringify(data);
            console.log(myJSON);
            Socket.send(myJSON);
        }

        // Send the WiFi credentials from the UI to the server for saving / using (via Websockets)
        function saveWiFiCrendentials() {
            var data = {
                Msg: "saveWiFiCredentials",
                MsgBody: {
                    // TODO: chnage this to an array of networks containig SSID & PWD pairs.
                    PrimarySSID:    document.getElementById('PrimarySSID').value,
                    PrimaryPwd:     document.getElementById('PrimaryPwd').value,
                    SecondarySSID:  document.getElementById('SecondarySSID').value,
                    SecondarydPwd:  document.getElementById('SecondarydPwd').value
                }
            };
            const myJSON = JSON.stringify(data);
            console.log(myJSON);
            Socket.send(myJSON);
            document.getElementById("status").innerHTML = "Credentials Saved";
        }

        // clear stored WiFi credentials
        function clearWiFiCrendentials() {
            document.getElementById("PrimaryPwd").innerHTML = "";
            document.getElementById("SecondarydPwd").innerHTML = "";
            var data = {
                Msg: "clearWiFiCredentials",
            };
            const myJSON = JSON.stringify(data);
            console.log(myJSON);
            Socket.send(myJSON);
            document.getElementById("status").innerHTML = "Credentials cleared";
        }

        // go back to previous (main) page
        function cancel() {
            window.history.back();
        }
    </script>
</body>
</html>