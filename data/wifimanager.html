<!-- 
DCB's WiFi Manager page
Some inspiration from https://github.com/khoih-prog/ESP_WiFiManager_Lite/blob/main/src/ESP_WiFiManager_Lite.hpage   
-->  
<!DOCTYPE html>
<html>
    <head>
        <title>Wi-Fi Manager</title>
        <meta name='viewport' content='width=device-width, initial-scale=1'>
        <style>
            div,input{padding:5px;font-size:100%;}
            select{text-align:left;display:inline-block;min-width:260px;font-size:100%;padding:5px;}
            input{width:95%;}
            body{text-align:center;}
            button{background-color:#16A1E7;color:#fff;line-height:2rem;font-size:100%;width:90%;}
            fieldset{border-radius:0.6rem;margin:0px;}
        </style>
    </head>
<body>
    <div style="font-size:80%;">
        <h1>Configure WiFi</h1>
    </div>
    <div style='text-align:left;display:inline-block;min-width:260px;'>
        <fieldset>
            <label for="PrimarySSID"><strong>Primary Network :</strong></label><br>
            <div>
                <select id='PrimarySSID'>
                    <option value="Select primary network ...">Select primary network ...</option>
                </select>
            </div>
            <label for="PrimaryPwd">Password</label> 
            <div><input value='' id='PrimaryPwd'></div>
            <hr>
            <label for="SecondarySSID"><strong>Secondary Network :</strong></label><br>
            <div>
                <select id='SecondarySSID'>
                    <option value="Select secondary network ...">Select secondary network ...</option>
                </select>
            </div>
            <label for="SecondarydPwd">Password</label> 
            <div><input value='' id='SecondarydPwd'></div>
            <hr>
                <label>Status: </label><label id="status"></label>
        </fieldset>
        <div></div>
        <table style='min-width:300px;'>
            <tr>
                <td align="center"><button onclick="scanWiFiNetworks()">Scan</button></td>
                <td align="center"><button onclick="saveWiFiCrendentials()">Save</button></td>
                <td align="center"><button onclick="clearWiFiCrendentials()">Clear</button></td>
                <td align="center"><button onclick="cancel()">Cancel</button></td>
            </tr>
        </table>
    </div>

    <script src="reconnecting-websockets.js"></script>
    <script id=\"jsbin-javascript\">

        var url = `ws://${window.location.hostname}/ws`;
        var Socket;
        var scanWiFiResults;
        var retrievedWiFiCredentials;       // see the "WiFi Credentials JSON format" body element in DCBWiFiManager.h
 
         // Create websocket object and set up handlers.
        document.addEventListener("DOMContentLoaded", function() {
        
            Socket = new ReconnectingWebSocket(url);
            Socket.debug = true;
            Socket.timeoutInterval = 1000;

            Socket.onopen = () => {
                console.log("Websocket connection established");
                // initial WiFi scan
                scanWiFiNetworks();
                // retrieves current WiFi credentials.
                readWiFiCrendentials();
            }

            Socket.onclose = () => {
                console.log("Websocket connection closed");
            }

            Socket.onerror = error => {
                console.log(error);
            }

            Socket.onmessage = function(event) {
                processCommand(event);
            }
        })

        // handler for incomming websocket events
        function processCommand(event) {
            console.log("Websocket data received:");
            console.log(event.data);

            var data = JSON.parse(event.data);   // The parse turns the JSON document into a Javascript object

            if(data.Msg =="retrievedWiFiCredentials") {
                // The expected JSON document is in the same format as saveWiFiCrendentials fuction below
                retrievedWiFiCredentials = data.MsgBody;
                // if we also have wifi results update the selections in the options lists.
                if(scanWiFiResults!=null) updateSelectedSSIDs();
            }
        }

        // Request a WiFI scan (HTTP GET), and handle scan results
        function scanWiFiNetworks() {
            document.getElementById("status").innerHTML = "Scanning...";
            console.log("Scanning WiFi Networks...");

            readWiFiCrendentials();  // refresh retrieved wificredentials.

            //clear any old entries in the list box (remove all but 1st entries)...
            var listbox, index;
            
            listbox= document.querySelector('#PrimarySSID');
            index = listbox.options.length;
            while (index-- > 1) listbox.remove(index);
            listbox= document.querySelector('#SecondarySSID');
            index = listbox.options.length;
            while (index-- > 1) listbox.remove(index);

            // Construct the 'scanWiFiNetwork" HTTP GET request
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'scanWiFiNetworks');

            // Define the handler for the response to the HTTP GET request:
            xhr.onload = function() {
                if (xhr.status === 200) {
                    if (xhr.responseText) { // if the returned data is not null, update the values
                        console.log("scanWiFiNetworks response:");
                        console.log(xhr.responseText);
                        
                        // The expected JSON document is in the format "{"SSIDs":["Net1","Net2", ...]}"
                        // The parse turns the JSON document into a Javascript object
                        scanWiFiResults = JSON.parse(xhr.responseText);

                         // Add WiFi networks to the HTML drop-down options. data.SSIDs is the array 
                         // of SSID's e.g a text string. 
                         // note using "for(e of array)" returns the text, and "for(e in array)" 
                         // returns just the index
                         for(SSID of scanWiFiResults.SSIDs) {
                            for(elem of ["PrimarySSID", "SecondarySSID"]) {
                                var option = document.createElement("option");
  			                    option.text = SSID;
   			                    document.getElementById(elem).add(option);
                            }
                        }
                        // if we also have credentails, update the selections in the options lists.
                        if(retrievedWiFiCredentials!=null) updateSelectedSSIDs();
                    }
                }
                document.getElementById("status").innerHTML = "Scan complete";
            };
            // Send the 'scanWiFiNetwork" HTTP GET request to the client
            xhr.send();
        }

        function readWiFiCrendentials() {
            var data = {
                Msg: "readWiFiCredentials"
            };
            const myJSON = JSON.stringify(data);
            console.log(myJSON);
            Socket.send(myJSON);
        }

        // in the dropdown / option SSID boxes, if possible set the read wifi SSID's as the selected ones.
        // this is called when we've had responses from readWiFiCrendentials and scanWiFiNetworks.
        function updateSelectedSSIDs() {
            for(SSID of scanWiFiResults.SSIDs) {
                if(SSID == retrievedWiFiCredentials[0].SSID) {
                    // set the selected value in the option lists to match the retrieved SSID.
                    document.getElementById("PrimarySSID").value = retrievedWiFiCredentials[0].SSID;
                    // and the corresponding password...
                    document.getElementById("PrimaryPwd").value = retrievedWiFiCredentials[0].Pwd;
                }
                if(SSID == retrievedWiFiCredentials[1].SSID) {
                    // set the selected value in the option lists to match the retrieved SSID.
                    document.getElementById("SecondarySSID").value = retrievedWiFiCredentials[1].SSID;
                    // and the corresponding password...
                    document.getElementById("SecondaryPwd").value = retrievedWiFiCredentials[1].Pwd;
                }
            }
        }

        // Send the WiFi credentials from the UI to the server for saving / using (via Websockets)
        function saveWiFiCrendentials() {
            var data = {
                Msg: "saveWiFiCredentials",
                MsgBody: 
                [
                    {
                        SSID:   document.getElementById('PrimarySSID').value,
                        Pwd:    document.getElementById('PrimaryPwd').value,
                    },
                    {
                        SSID:   document.getElementById('SecondarySSID').value,
                        Pwd:    document.getElementById('SecondarydPwd').value
                    }
                ]
            };
            const myJSON = JSON.stringify(data);
            console.log(myJSON);
            Socket.send(myJSON);
            document.getElementById("status").innerHTML = "Credentials Saved";
        }

        // clear stored WiFi credentials
        function clearWiFiCrendentials() {
            document.getElementById("PrimaryPwd").innerHTML = "";
            document.getElementById("SecondarydPwd").innerHTML = "";
            var data = {
                Msg: "clearWiFiCredentials",
            };
            const myJSON = JSON.stringify(data);
            console.log(myJSON);
            Socket.send(myJSON);
            document.getElementById("status").innerHTML = "Credentials cleared";
        }

        // go back to previous (main) page
        function cancel() {
            window.history.back();
        }
    </script>
</body>
</html>